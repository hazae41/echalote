{"version":3,"file":"tcp.cjs","sources":["../../../../../src/mods/tor/streams/tcp.ts"],"sourcesContent":["import { Binary } from \"libs/binary.js\";\nimport { Events } from \"libs/events.js\";\nimport { RelayDataCell } from \"mods/tor/binary/cells/relayed/relay_data/cell.js\";\nimport { RelayEndCell } from \"mods/tor/binary/cells/relayed/relay_end/cell.js\";\nimport { RelayEndReasonOther } from \"mods/tor/binary/cells/relayed/relay_end/reason.js\";\nimport { RelayTruncatedCell } from \"mods/tor/binary/cells/relayed/relay_truncated/cell.js\";\nimport { Circuit } from \"mods/tor/circuit.js\";\nimport { PAYLOAD_LEN } from \"mods/tor/constants.js\";\n\nexport interface AbortEvent extends Event {\n  type: \"abort\"\n  target: AbortSignal\n  currentTarget: AbortSignal\n}\n\nconst DATA_LEN = PAYLOAD_LEN - (1 + 2 + 2 + 4 + 2)\n\nexport class TcpStream extends EventTarget {\n  /**\n   * Output stream bufferer\n   */\n  readonly rstreams = new TransformStream<Buffer, Buffer>()\n\n  /**\n   * Input stream bufferer\n   */\n  readonly wstreams = new TransformStream<Buffer, Buffer>()\n\n  /**\n   * Output stream\n   */\n  readonly readable = this.rstreams.readable\n\n  /**\n   * Input stream\n   */\n  readonly writable = this.wstreams.writable\n\n  private closed = false\n\n  constructor(\n    readonly circuit: Circuit,\n    readonly id: number,\n    readonly signal?: AbortSignal\n  ) {\n    super()\n\n    const onRelayDataCell = this.onRelayDataCell.bind(this)\n    this.circuit.addEventListener(\"RELAY_DATA\", onRelayDataCell, { passive: true })\n\n    const onRelayEndCell = this.onRelayEndCell.bind(this)\n    this.circuit.addEventListener(\"RELAY_END\", onRelayEndCell, { passive: true })\n\n    const onRelayTruncatedCell = this.onRelayTruncatedCell.bind(this)\n    this.circuit.addEventListener(\"RELAY_TRUNCATED\", onRelayTruncatedCell, { passive: true })\n\n    const onAbort = this.onAbort.bind(this)\n    this.signal?.addEventListener(\"abort\", onAbort, { passive: true, once: true })\n\n    this.tryWrite().catch(console.warn)\n  }\n\n  private async onAbort(event: Event) {\n    const abort = event as AbortEvent\n\n    const event2 = Events.clone(event)\n    if (!this.dispatchEvent(event2)) return\n\n    if (this.closed) return\n\n    this.closed = true\n\n    const rwriter = this.rstreams.writable.getWriter()\n    rwriter.abort(abort.target.reason).catch(console.warn)\n    rwriter.releaseLock()\n\n    const wwriter = this.wstreams.writable.getWriter()\n    wwriter.abort(abort.target.reason).catch(console.warn)\n    wwriter.releaseLock()\n\n    const reason = RelayEndCell.reasons.REASON_UNKNOWN\n    const reason2 = new RelayEndReasonOther(reason)\n    const cell = new RelayEndCell(this.circuit, this, reason2)\n    this.circuit.tor.send(await cell.pack())\n  }\n\n  private async onRelayDataCell(event: Event) {\n    const message = event as MessageEvent<RelayDataCell>\n    if (message.data.stream !== this) return\n\n    const message2 = Events.clone(message)\n    if (!this.dispatchEvent(message2)) return\n\n    if (this.closed) return\n\n    const rwriter = this.rstreams.writable.getWriter()\n    rwriter.write(message.data.data).catch(console.warn)\n    rwriter.releaseLock()\n  }\n\n  private async onRelayEndCell(event: Event) {\n    const message = event as MessageEvent<RelayEndCell>\n    if (message.data.stream !== this) return\n\n    const message2 = Events.clone(message)\n    if (!this.dispatchEvent(message2)) return\n\n    if (this.closed) return\n\n    this.closed = true\n\n    const rwriter = this.rstreams.writable.getWriter()\n    rwriter.close().catch(console.warn)\n    rwriter.releaseLock()\n\n    const wwriter = this.wstreams.writable.getWriter()\n    wwriter.close().catch(console.warn)\n    wwriter.releaseLock()\n  }\n\n  private async onRelayTruncatedCell(event: Event) {\n    const message = event as MessageEvent<RelayTruncatedCell>\n\n    const message2 = Events.clone(message)\n    if (!this.dispatchEvent(message2)) return\n\n    if (this.closed) return\n\n    this.closed = true\n\n    const rwriter = this.rstreams.writable.getWriter()\n    rwriter.abort(event).catch(console.warn)\n    rwriter.releaseLock()\n\n    const wwriter = this.wstreams.writable.getWriter()\n    wwriter.abort(event).catch(console.warn)\n    wwriter.releaseLock()\n  }\n\n  private async tryWrite() {\n    const reader = this.wstreams.readable.getReader()\n\n    try {\n      await this.write(reader)\n    } catch (e: unknown) {\n      console.warn(e)\n    } finally {\n      reader.releaseLock()\n    }\n  }\n\n  private async write(reader: ReadableStreamReader<Buffer>) {\n    while (true) {\n      const { done, value } = await reader.read()\n\n      if (done) break\n\n      await this.onWrite(value)\n    }\n  }\n\n  private async onWrite(chunk: Buffer) {\n    if (chunk.length <= DATA_LEN) {\n      const cell = new RelayDataCell(this.circuit, this, chunk)\n      return this.circuit.tor.send(await cell.pack())\n    }\n\n    const binary = new Binary(chunk)\n    const chunks = binary.split(DATA_LEN)\n\n    for (const chunk of chunks) {\n      const cell = new RelayDataCell(this.circuit, this, chunk)\n      this.circuit.tor.send(await cell.pack())\n    }\n  }\n}"],"names":["PAYLOAD_LEN","Events","reason","RelayEndCell","RelayEndReasonOther","cell","RelayDataCell","binary","Binary"],"mappings":"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"}