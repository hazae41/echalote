{"version":3,"file":"relay_begin.cjs","sources":["../../../../../../../src/mods/tor/binary/cells/relayed/relay_begin.ts"],"sourcesContent":["import { Binary } from \"libs/binary.js\";\nimport { Bitmask } from \"libs/bits.js\";\nimport { RelayCell } from \"mods/tor/binary/cells/direct/relay.js\";\nimport { InvalidRelayCommand, InvalidStream } from \"mods/tor/binary/cells/errors.js\";\nimport { Circuit } from \"mods/tor/circuit.js\";\nimport { PAYLOAD_LEN } from \"mods/tor/constants.js\";\nimport { TcpStream } from \"mods/tor/streams/tcp.js\";\n\nexport class RelayBeginCell {\n  readonly class = RelayBeginCell\n\n  static rcommand = 1\n\n  static flags = {\n    IPV4_OK: 0,\n    IPV6_NOT_OK: 1,\n    IPV6_PREFER: 2\n  }\n\n  constructor(\n    readonly circuit: Circuit,\n    readonly stream: TcpStream,\n    readonly address: string,\n    readonly flags: Bitmask\n  ) { }\n\n  async pack() {\n    return await this.cell().pack()\n  }\n\n  cell() {\n    const binary = Binary.allocUnsafe(PAYLOAD_LEN)\n\n    binary.writeNullString(this.address)\n    binary.writeUint32(this.flags.n)\n    binary.fill()\n\n    return new RelayCell(this.circuit, this.stream, this.class.rcommand, binary.sliced)\n  }\n\n  static uncell(cell: RelayCell) {\n    if (cell.rcommand !== this.rcommand)\n      throw new InvalidRelayCommand(this.name, cell.rcommand)\n    if (!cell.stream)\n      throw new InvalidStream(this.name, cell.stream)\n\n    const binary = new Binary(cell.data)\n\n    const address = binary.readNullString()\n    const flagsn = binary.readUint32()\n    const flags = new Bitmask(flagsn)\n\n    return new this(cell.circuit, cell.stream, address, flags)\n  }\n}"],"names":["binary","Binary","PAYLOAD_LEN","RelayCell","InvalidRelayCommand","InvalidStream","Bitmask"],"mappings":";;;;;;;;;MAQa,cAAc,CAAA;AAWzB,IAAA,WAAA,CACW,OAAgB,EAChB,MAAiB,EACjB,OAAe,EACf,KAAc,EAAA;QAHd,IAAO,CAAA,OAAA,GAAP,OAAO,CAAS;QAChB,IAAM,CAAA,MAAA,GAAN,MAAM,CAAW;QACjB,IAAO,CAAA,OAAA,GAAP,OAAO,CAAQ;QACf,IAAK,CAAA,KAAA,GAAL,KAAK,CAAS;QAdhB,IAAK,CAAA,KAAA,GAAG,cAAc,CAAA;KAe1B;IAEC,IAAI,GAAA;;YACR,OAAO,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC,IAAI,EAAE,CAAA;SAChC,CAAA,CAAA;AAAA,KAAA;IAED,IAAI,GAAA;QACF,MAAMA,QAAM,GAAGC,aAAM,CAAC,WAAW,CAACC,qBAAW,CAAC,CAAA;AAE9C,QAAAF,QAAM,CAAC,eAAe,CAAC,IAAI,CAAC,OAAO,CAAC,CAAA;QACpCA,QAAM,CAAC,WAAW,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAA;QAChCA,QAAM,CAAC,IAAI,EAAE,CAAA;QAEb,OAAO,IAAIG,eAAS,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,KAAK,CAAC,QAAQ,EAAEH,QAAM,CAAC,MAAM,CAAC,CAAA;KACpF;IAED,OAAO,MAAM,CAAC,IAAe,EAAA;AAC3B,QAAA,IAAI,IAAI,CAAC,QAAQ,KAAK,IAAI,CAAC,QAAQ;YACjC,MAAM,IAAII,0BAAmB,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAA;QACzD,IAAI,CAAC,IAAI,CAAC,MAAM;YACd,MAAM,IAAIC,oBAAa,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,MAAM,CAAC,CAAA;QAEjD,MAAML,QAAM,GAAG,IAAIC,aAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;AAEpC,QAAA,MAAM,OAAO,GAAGD,QAAM,CAAC,cAAc,EAAE,CAAA;AACvC,QAAA,MAAM,MAAM,GAAGA,QAAM,CAAC,UAAU,EAAE,CAAA;AAClC,QAAA,MAAM,KAAK,GAAG,IAAIM,YAAO,CAAC,MAAM,CAAC,CAAA;AAEjC,QAAA,OAAO,IAAI,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,MAAM,EAAE,OAAO,EAAE,KAAK,CAAC,CAAA;KAC3D;;AA1CM,cAAQ,CAAA,QAAA,GAAG,CAAC,CAAA;AAEZ,cAAA,CAAA,KAAK,GAAG;AACb,IAAA,OAAO,EAAE,CAAC;AACV,IAAA,WAAW,EAAE,CAAC;AACd,IAAA,WAAW,EAAE,CAAC;CACf;;;;"}