{"version":3,"file":"create2.cjs","sources":["../../../../../../../src/mods/tor/binary/cells/direct/create2.ts"],"sourcesContent":["import { Binary } from \"libs/binary.js\";\nimport { NewCell } from \"mods/tor/binary/cells/cell.js\";\nimport { Circuit } from \"mods/tor/circuit.js\";\nimport { PAYLOAD_LEN } from \"mods/tor/constants.js\";\n\nexport class Create2Cell {\n  readonly class = Create2Cell\n\n  static command = 10\n\n  static types = {\n    /**\n     * The old, slow, and insecure handshake\n     * @deprecated\n     */\n    TAP: 0,\n    /**\n     * The new, quick, and secure handshake\n     */\n    NTOR: 2\n  }\n\n  constructor(\n    readonly circuit: Circuit,\n    readonly type: number,\n    readonly data: Buffer\n  ) { }\n\n  pack() {\n    return this.cell().pack()\n  }\n\n  cell() {\n    const binary = Binary.allocUnsafe(PAYLOAD_LEN)\n\n    binary.writeUint16(this.type)\n    binary.writeUint16(this.data.length)\n    binary.write(this.data)\n    binary.fill()\n\n    return new NewCell(this.circuit, this.class.command, binary.buffer)\n  }\n\n  static uncell(cell: NewCell) {\n    if (cell.command !== this.command)\n      throw new Error(`Invalid CREATE2 cell command ${cell.command}`)\n    if (!cell.circuit)\n      throw new Error(`Can't uncell CREATE2 cell on circuit 0`)\n\n    const binary = new Binary(cell.payload)\n\n    const type = binary.readUint16()\n    const length = binary.readUint16()\n    const data = binary.read(length)\n\n    return new this(cell.circuit, type, data)\n  }\n}"],"names":["binary","Binary","PAYLOAD_LEN","NewCell"],"mappings":";;;;;;MAKa,WAAW,CAAA;AAiBtB,IAAA,WAAA,CACW,OAAgB,EAChB,IAAY,EACZ,IAAY,EAAA;QAFZ,IAAO,CAAA,OAAA,GAAP,OAAO,CAAS;QAChB,IAAI,CAAA,IAAA,GAAJ,IAAI,CAAQ;QACZ,IAAI,CAAA,IAAA,GAAJ,IAAI,CAAQ;QAnBd,IAAK,CAAA,KAAA,GAAG,WAAW,CAAA;KAoBvB;IAEL,IAAI,GAAA;AACF,QAAA,OAAO,IAAI,CAAC,IAAI,EAAE,CAAC,IAAI,EAAE,CAAA;KAC1B;IAED,IAAI,GAAA;QACF,MAAMA,QAAM,GAAGC,aAAM,CAAC,WAAW,CAACC,qBAAW,CAAC,CAAA;AAE9C,QAAAF,QAAM,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;QAC7BA,QAAM,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAA;AACpC,QAAAA,QAAM,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;QACvBA,QAAM,CAAC,IAAI,EAAE,CAAA;AAEb,QAAA,OAAO,IAAIG,YAAO,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,KAAK,CAAC,OAAO,EAAEH,QAAM,CAAC,MAAM,CAAC,CAAA;KACpE;IAED,OAAO,MAAM,CAAC,IAAa,EAAA;AACzB,QAAA,IAAI,IAAI,CAAC,OAAO,KAAK,IAAI,CAAC,OAAO;YAC/B,MAAM,IAAI,KAAK,CAAC,CAAA,6BAAA,EAAgC,IAAI,CAAC,OAAO,CAAE,CAAA,CAAC,CAAA;QACjE,IAAI,CAAC,IAAI,CAAC,OAAO;AACf,YAAA,MAAM,IAAI,KAAK,CAAC,CAAA,sCAAA,CAAwC,CAAC,CAAA;QAE3D,MAAMA,QAAM,GAAG,IAAIC,aAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAA;AAEvC,QAAA,MAAM,IAAI,GAAGD,QAAM,CAAC,UAAU,EAAE,CAAA;AAChC,QAAA,MAAM,MAAM,GAAGA,QAAM,CAAC,UAAU,EAAE,CAAA;QAClC,MAAM,IAAI,GAAGA,QAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAAA;QAEhC,OAAO,IAAI,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,CAAA;KAC1C;;AAhDM,WAAO,CAAA,OAAA,GAAG,EAAE,CAAA;AAEZ,WAAA,CAAA,KAAK,GAAG;AACb;;;AAGG;AACH,IAAA,GAAG,EAAE,CAAC;AACN;;AAEG;AACH,IAAA,IAAI,EAAE,CAAC;CACR;;;;"}